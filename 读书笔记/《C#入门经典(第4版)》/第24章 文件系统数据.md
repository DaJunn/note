# 第24章 文件系统数据

本章将学习如何读写文件，这是许多.NET应用程序的一个基础性工作。我们要讨论用于创建、读写文件的主要类，支持在C#代码中处理文件系统的类。本章不详细介绍全部的类，但将深入介绍一些类，以便于读者理解概念和基本理论。

文件是在应用程序的实例之间存储数据的一种便利方式，也可以用于在应用程序之间传输数据。可以存储用户和应用程序配置，以便在下一次运行应用程序时检索它们。定界的文本文件，例如用逗号分隔的文件，由许多老系统使用，也能与其他需要了解如何处理定界数据的系统一起使用。.NET Framework提供的工具可以在应用程序中有效地使用文件。

**本章的主要内容：**

* 流是什么，以及.NET如何使用流类访问文件
* 如何使用File对象处理文件结构
* 如何读写文件
* 如何在文件中读写格式化的数据
* 如何读写压缩文件
* 如何序列化和解序对象
* 如何监控文件和目录的变化

## 24.4 监控文件结构

有时，应用程序所需要完成的工作不仅仅限于从文件系统中读写文件。例如，知道修改文件或目录的时间非常重要。.NET Framework能很容易创建完成这些任务的定制应用程序。

帮助完成这些任务的类似FileStyleWatcher。这个类提供了几个应用程序可以捕获的事件。应用程序可以对文件系统事件作出响应。

使用FileSystemWatcher的基本过程非常简单。首先必须设置一些属性，指定监控的位置、内容以及引发应用程序要处理的事件的时间。然后给FileSystemWatcher提供定制事件处理程序的地址，当发生重要事件时，FileSystemWatcher就调用这些熟悉。然后打开FileSystem Watcher，等待事件。

在启用FileSystemWatcher对象之前必须设置的属性如表24-10所示。

| 属性         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| Path         | 它设置要监控的文件位置或目录                                 |
| NotifyFilter | 这是NotifyFilters枚举值的组合，NotifyFilters枚举值规定在被监控的文件内要监控哪些内容。这些表示要监控的文件或文件夹的属性。如果规定的属性发生了变化，就引发事件。可能的枚举值是：Attributes、CreationTime、DirectoryName、FileName、LastAccess、LastWrite、Security和Size。注意，可以通过二元OR操作符来合并这些枚举值 |
| Filter       | 监控文件的过滤器，例如，*.txt                                |

设置之后，就必须为4个事件Changed、Created、Deleted和Renamed编写事件处理程序。如第13章所述，这需要创建自己的方法，并将方法赋给对象的事件。将自己的事件处理程序赋给这些方法，就可以在引发事件时调用方法。当修改与Path、NotifyFilter和Filter属性匹配的文件或目录时，就引发每一个事件。

在设置了属性和事件之后，将EnableRaisingEvents属性设置为true，就可以开始监控工作。下面的示例将在一个简单的客户应用程序中使用FileSystemWatcher，来监控所选目录上的选项卡。

**试试看：监控文件系统**

这是一个较复杂的示例，使用了本章介绍的许多内容。

（1）创建一个新的Windows应用程序FileWatch。

（2）使用表24-11中所示的属性设置各种窗体属性。

## 24.5 小结

本章学习了流和在.NET Framework中使用流访问文件和其他串行设备的原因。我们介绍了System.IO名称空间中的基类，包括：

* File
* FileInfo
* FileStream

File类提供了许多静态方法，用于移动、复制和删除文件，FileInfo表示磁盘上的一个物理文件，其方法可以处理该文件。FileStream对象表示只读、只写或读写的文件。我们还介绍了StreamReader和StreamWriter类，以及它们在写入流时的作用。学习了使用FileStream类读写随机文件的方法。在此基础上，使用System.IO.Compression名称空间中的类在把流写入磁盘时压缩流，以及把对象序列化到文件中。最后构建了一个完整的应用程序，使用FileSystemWatcher类监控文件和目录。

概括地说，本章学习了：

* 打开文件，读取文件，写入文件
* StreamWriter和StreamReader类与FileStream类的区别
* 使用分隔符分隔的文件填充数据结构
* 压缩和解压缩流
* 序列化和解序对象
* 使用FileSystemWatcher类监控文件系统

