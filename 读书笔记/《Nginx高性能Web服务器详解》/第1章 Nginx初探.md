# 第1章 Nginx初探

Nginx服务器是轻量级Web服务器中广受好评的一款产品。从本章我们开始Nignx服务器的学习和实践。

在本章中，我们主要探究Nginx服务器是什么，它在相关的行业领域内地位如何，它有哪些用途等问题。我们将追随Nginx服务器由诞生到快速发展的历史轨迹，了解Nginx服务器提供了哪些令人兴奋的功能和特性。

在这一章中我们主要学习以下几个方面的内容：

* 常见的Web服务器产品。
* Nginx服务器的诞生和发展。
* Nginx服务器的功能和特性。

## 1.1 Nginx的历史

近几年来，Nginx逐步进入高速发展的时期，从各种主流的IT媒体到各大著名的IT论坛，我们不时能够看到它的身影。

Netcraft公司，1994年在英国成立，官方网址为http://uptime.netcraft.com。Netcraft公司为互联网市场以及在线安全方面提供咨询服务，同时针对网站服务器、域名解析1.

## 1.3 Nginx的功能特性

Nginx服务器以其功能丰富著称于世。它既可以作为HTTP服务器，也可以作为反向代理服务器或者邮件服务器；能够快速响应静态页面（HTML）的请求；支持FastCGI、SSL、Virtual Host、URL Rewrite、HTTP Basic Auth、Gzip等大量使用功能；并且支持更多的第三方功能模块的扩展。

* Nginx提供基本HTTP服务，可以作为HTTP代理服务器和反向代理服务器，支持通过缓存加速访问，可以完成简单的负载均衡和容错，支持包过滤功能，支持SSL等。
* Nginx提供高级HTTP服务，可以进行自定义配置，支持虚拟主机，支持URL重定向，支持网络监控，支持流媒体传输等。
* Nginx作为邮件代理服务器是最早开发这个产品的目的之一，它支持IMAP/POP3代理服务功能，支持内部SMTP代理服务功能。

### 1.3.1 基本HTTP服务

在Nginx提供的基本HTTP服务中，主要包含以下功能特性：

* 处理静态文件（如HTML静态网页及请求）；处理索引文件以及支持自动索引。
* 打开并自行管理文件描述符缓存。
* 提供反向代理服务，并且可以使用缓存加速反向代理，同时完成简单负载均衡及容错。
* 提供远程FastCGI服务的缓存机制，加速访问，同时完成简单的负载均衡以及容错。
* 使用Nginx模块化特性提供过滤器功能。Nginx基本过滤器包括gzip压缩、ranges支持、chunked响应、XSLT、SSI以及图像缩放等。其中，针对包含多个SSI的页面，经由FastCGI或反向代理，SSI过滤器可以并行处理。
* 支持HTTP下的安全套接层安全协议SSL。

### 1.3.2 高级HTTP服务

在Nginx提供的高级HTTP服务中，主要包含以下功能特性：

* 支持基于名称和IP的虚拟主机设置，在以后的章节中大家将看到具体应用。
* 支持HTTP/1.0中的KEEP-Alive模式和管线（PipeLined）模型连接。
* 支持重新加载配置以及在线升级时，无须中断正在处理的请求。
* 自定义访问日志格式、带缓存的日志写操作以及快速日志轮转。
* 支持重写（Rewrite）模块扩展。
* 支持HTTP DAV模块，从而为Http WebDAV提供PUT、DELETE、MKCOL、COPY以及MOVE方法。
* 支持FLV流和MP4流传输。
* 支持网络监控，包括基于客户端IP地址和HTTP基本认证机制的访问控制、速度限制、来自同一地址的同时连接数或请求数限制等。
* 支持嵌入Perl语言。

### 1.3.3 邮件代理服务

Nginx提供邮件代理服务也是其基本开发需求之一，主要包含以下功能特性：

* 支持使用外部HTTP认证服务器重定向用户到IMAP/POP3后端，并支持IMAP认证方式（LOGIN、AUTH LOGIN/PLAIN/CRAM-MD5）和POP3认证方式（USER/PASS、APOP、AUTH LOGIN/PLAN/CRAM-MD5）。
* 支持使用外部HTTP认证服务器认证用户后重定向连接到内部SMTP后端，并支持SMTP认证方式（AUTH LOGIN/PLAIN/CRAM-MD5）。
* 支持邮件代理服务下的安全套接层安全协议SSL。
* 支持纯文本通信协议的扩展协议STARTTLS。

由以上的功能列表可以看到，Nginx作为邮件代理服务器也是具备完善功能的。

## 1.4 常用功能介绍

这部分在内容上和其他部分没有明显的连贯性，主要是根据笔者的实践经验，选择Nginx服务器最常涉及的几个功能对其进行进一步阐述，其目的是阐明相关概念，为我们以后的学习奠定良好的知识基础。

### 1.4.1 HTTP代理和反向代理

代理服务和反向代理服务是Nginx服务器作为Web服务器的主要功能之一，尤其是反向代理服务，是应用十分广泛的功能。

在提供反向代理服务方面，Nginx服务器转发前端请求性能稳定，并且后端转发与业务配置相互分离，配置相当灵活。在后面的章节我们可以看到，在进行Nginx服务器配置时，配置后端转发请求完全不用关心网络环境如何，可以指定任意的IP地址和端口号，或其他类型的链接、请求等。

Nginx服务器的反向代理服务功能并不只有这些，它提供的配套功能相当丰富。首先，它支持判断表达式。通过使用正则表达式进行相关配置，可以实现根据不同的表达式，采取不同的转发策略。其次，它对后端返回情况进行了异常判断，如果返回结果不正常，则重新请求另一台主机（即将前端请求转向另一后端IP），并自动剔除返回异常的主机。它还支持错误页面跳转功能。

谈到Nginx服务器的反向代理功能的应用，就不能不提到它在解决网络负载、性能方面的一个出色功能，这也是Nginx服务器的另一个重要的能力——负载均衡。

### 1.4.2 负载均衡

负载均衡，一般包含两方面的含义。一方面是，将单一的重负载分担到多个网络节点上做并行处理，每个节点处理结束后将结果汇总返回给用户，这样可以大幅提高网络系统的处理能力；第二个方面的含义是，将大量的前端并发访问或数据流量分担到多个后端网络节点上分别处理，这样可以有效减少前端用户等待响应的时间。Web服务器、FTP服务器、企业关键应用服务器等网络应用方面谈到的负载均衡问题，基本隶属于后一方面的含义。因此，Nginx服务器的负载均衡主要是对大量前端访问和流量进行分流，以保证前端用户访问效率。可以说，在绝大多数的Nginx应用中，都会或多或少涉及它的负载均衡服务。

Nginx服务器的负载均衡策略可以划分为两大类：即内置策略和扩展策略。内置策略主要包含轮询、加权轮询和IP hash三种；扩展策略主要通过第三方模块实现，种类比较丰富，常见的有url hash、fair等。

在默认情况下，内置策略会被编译进Nginx内核，使用时只需要在Nginx服务器配置中设置相关参数即可，我们在专门的章节中会详细阐述；扩展策略不会编译进Nginx内核，需要手动将第三方模块编译到Nginx内核。第三方模块的编译技术也留在后文专门讲解。下面简单介绍一下几种负载均衡策略的实现原理。

轮询策略比较简单，就是将每个前端请求按顺序（时间顺序或者排序次序）逐一分配到不同的后端节点上，对于出现问题的后端节点自动排除。加权轮询策略，顾名思义，就是在基本的轮询策略上考虑各后端节点接收请求的权重，指定各后端节点被轮询到的几率。加权轮询策略主要用于后端节点性能不均的情况。根据后端节点性能的实际情况，我们可以在Nginx服务器的配置文件中调整权值，使得整个网络对前端请求达到最佳的响应能力。

IP hash策略，是将前端的访问IP进行hash操作，然后根据hash结果将请求分配给不同的后端节点。事实上，这种策略可以看作是一种特殊的轮询策略。通过Nginx的实现，每个前端访问IP会固定访问一个后端节点。这样做的好处是避免考虑前端用户的session在后端多个节点上共享的问题。

扩展策略中的url hash在形式上和IP hash相近，不同之处在于，IP hash策略是对前端访问IP进行了hash操作，而url hash策略是对前端请求的url进行了hash操作。url hash策略的优点在于，如果后端有缓存服务器，它能够提高缓存效率，同时也解决了session的问题；但其缺点是，如果后端节点出现异常，它不能自动排除该结点。在实际使用过程中笔者发现，后端节点出现异常会导致Nginx服务器返回503错误。

扩展的第三方模块fair则是从另一个角度来实现Nginx服务器负载均衡策略的。该模块将前端请求转发到一个最近负载最小的后台节点。那么，负载最小怎么判断呢？Nginx通过后端节点对请求的响应时间来判断负载情况。响应时间短的结点负载相对就轻。得出判断结果后，Nginx就将前端请求转发到选中的负载最轻的节点。

### 1.4.3 Web缓存

相信不少读者对Squid有所了解。它在Web服务器领域中是一款相当流行的开源代理服务器和Web缓存服务器。作为网页服务器的前置缓存服务器，在很多优秀的站点中，它被用以缓存前端请求，从而提高Web服务器的性能；而且，它还可以缓存万维网、域名系统或者其他网络搜索等，为一个集体提供网络资源共享服务。

Nginx服务器从0.748版本开始，也支持了和Squid类似的缓存功能。在本节中，我们主要介绍几个将在后文中涉及的重要知识点，具体的技术细节将放在专门的章节中详细讨论。

Nginx服务器的Web缓存服务主要由Proxy_Cache相关指令集和FastCGI_Cache相关指令集构成。其中，Proxy_Cache主要用于在Nginx服务器提供反向代理服务时，对后端源服务器的返回内容URL缓存；FastCGI_Cache主要用于对FastCGI的动态程序进行缓存。另外还有一款常用的第三方模块ngx_cache_purge也是Nginx服务器Web缓存功能中经常用到的。它主要用于清除Nginx服务器上指定的URL缓存。

到Nginx 0.8.32版本，Proxy_Cache和FastCGI_Cache两部分的功能已经比较完善，再配合第三方的ngx_cache_purge模块，Nginx服务器已经具备了Squid所拥有的Web缓存加速功能和清除指定URL缓存的功能；同时，Nginx服务器对多核CPU的调度比Squid更胜一筹，性能高于Squid，而在反向代理、负载均衡等其他方面，Nginx也不逊于Squid。这使得Nginx服务器可以同时作为负载均衡服务器和Web缓存服务器来使用，基本可以取代Squid。

## 1.5 本章小结

本章是全书的第一章，首先介绍了几种市场占用率较高的服务器产品，其中有大型的Web服务器，如Apache、IIS；也有轻量级的Web服务器，如Lighttpd等；由此引出后来居上的Nginx服务器。接着，我们回顾了Nginx服务器的发展历程，对它能够在短时间内异军突起的市场表现充满了好奇。究竟是什么因素使得Nginx服务器能够在激烈的Web服务器市场竞争中占领一席之地呢？为了找到原因，我们对Nginx服务器的功能特性进行了简单梳理，并且选取反向代理功能、负载均衡功能、Web缓存服务三个功能点进行了进一步的阐述。

