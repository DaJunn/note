# 第2章 Nginx服务器的安装部署

在开始Nginx学习旅程之前，需要说明的是，本书着眼于Nginx服务器的实际应用，我们希望通过对Nginx服务器的系统介绍，能够在最短时间内尽可能向大家全面展示Nginx服务器常见的应用场景；也希望为在实际开展和Nginx服务器相关工作和学习的过程中遇到问题的人员提供指导和参考。

本章首先为大家介绍Nginx服务器的基本安装部署。我们将在本章学习到以下知识：

* 获取Nginx服务器安装文件的途径。
* Nginx服务器安装部署之前的装备工作。
* Windows平台下Nginx服务器的安装部署。
* Linux平台下Nginx服务器的编译和安装。
* 认识Nginx服务器的配置文件，以及如何进行基本配置。
* 初步学习通过优化Nginx配置，提高Nginx服务器的性能。
* 展示一个Nginx配置的完整实例。

## 2.1 如何获取Nginx服务器安装文件

Nginx服务器的软件版本包括Windows版和Linux版两种，在官方网站上可以找到对应版本的下载链接。下面详细介绍如何获取所需版本的Nginx服务器软件。

### 2.1.1 获取新版本的Nginx服务器

Nginx的官方下载网站为http://nginx.org/en/download.html。打开网站，下载部分的内容如图2.1所示。可以看到，网页上提供了Nginx服务器三种版本的下载，分别是开发版本（Development version）、稳定版（Stable version）和过期版本（Legacy versions）。三种本包的差异和选择在第1章中已经介绍过，这里不再赘述。本页提供下载的各类版本均为Nginx的较新版本。其中，开发版本同时也是Nginx全部版本中最新的版本。

下面分别介绍页面上下载部分各链接的具体含义：

“CHANGES-x.x”链接，记录的是对应版本的功能变更日志。包括新增功能、功能的优化和功能缺陷的修复等等。

紧接着“CHANGES-x.x”链接后面的“nginx-x.x.x”的链接，是Nginx服务器的Linux版本下载链接。右击链接，选择“另存为”命令或者选择下载专用工具就可以获取到Nginx服务器的Linux版本。得到的文件的后缀为tar.gz。

“pgp”链接，记录的是提供下载的版本使用PGP加密自由软件GnuPG计算后的签名。PGP可以解释为Pretty Good Privacy，是PGP公司的加密或签名工具套件。点击链接进入相关页面，可以查看GnuPG针对本下载版本的签名，以及执行本次计算的GnuPG软件版本号。这些数据可以用于下载文件的验证。

“nginx/Windows-x.x.x”链接，是Nginx服务器的Windows版本下载链接，下载方法和Linux版本相同。得到的文件的后缀名为.zip。

![1558075419171](assets/1558075419171.png)

### 2.1.2 获取Nginx服务器的历史版本

在第1章中，我们了解到Nginx服务器包含众多的历史版本。Nginx官方网站没有显式提供下载历史版本的链接，但是如果由于特殊的需求需要获取Nginx服务器的历史版本，该怎么做呢？

笔者为大家介绍一个可以下载Nginx服务器全部历史版本的链接，即http://nginx.org/download。打开此网页，可以看到Nginx全部历史版本的列表，从nginx-0.1.0到nginx-1.3.5一应俱全，下载方式和上面介绍的新版本Nginx服务器软件下载方式相同。

仔细查看版本列表，可以发现以nginx-0.7.52为分界线，之前的低版本只提供后缀名为.tar.gz的Linux版本，从nginx-0.7.52开始同时提供后缀名为.zip的Windows版本，出现这种现象的原因我们在第1章回顾Nginx服务器发展历史时已经说明。从nginx-0.7.64开始，还提供了后缀名为.asc的文件，该文件记录了Linux版本PGP加密自由软件签名数据。

## 2.2 安装Nginx服务器和基本配置

上一节我们获取了自己需要的Nginx服务器版本。笔者使用的版本是2012年8月7日发布的稳定版本nginx-1.2.3，包括Windows版本和Linux版本。本书后文中涉及的Nginx服务器使用、Nginx服务器软件源代码分析均以此版本为基础。

本文主要指导大家在Windows平台和Linux平台上安装Nginx服务器软件。

### 2.2.1 Windows版本的安装

Windows版本的Nginx服务器安装方法与一般的Windows安装程序有所不同。

我们获取的Windows版本Nginx服务器安装文件为nginx-1.2.3.zip压缩文件。安装Windows版本的Nginx服务器不需要进行特殊的安装操作，使用解压工具解压此压缩文件后，得到如图2.2所示的文件资源，这就是nginx服务器运行的全部资源。

![1558076893274](assets/1558076893274.png)

Windows版本的Nginx服务器在效率上比Linux版本要差一些，并且Nginx在实际使用中一般用在Linux/Unix系统中，本文以Nginx1.2.3版为学习重点进行说明。但为了方便后续的学习，我们还是有必要对解压出来的部分文件和目录做简单的介绍。

* **conf** 目录中存放的是Nginx服务器的配置文件，包含Nginx服务器的基本配置文件和对部分特性的配置文件。在本节的后文中，我们将重点介绍名为nginx.conf的配置文件如何使用了。正确配置此文件可以保证Nginx服务器的正常运行。其他配置文件将在后续相关章节中陆续提及。
* **docs** 目录中存放了Nginx服务器的文档资料，包含Nginx服务器的LICENSE、OpenSSL的LICENSE、PCRE的LICENCE以及zlib的LICENSE，还包括本版本Nginx服务器升级的版本变更说明，以及README文档。如果想了解Nginx服务器的具体细节，可以访问Nginx的官方网站http://www.nginx.org。另外，http://wiki.nginx.org/Main也是了解Nginx服务器相关信息的不错网站。
* **html** 目录中存放了两个后缀名为.html的静态页面文件。这两个文件与Nginx服务器的运行相关，在后面介绍Nginx启动时将介绍这两个文件，在此不再赘述。
* **logs** 目录中存放了Nginx服务器的运行日志文件。我们将在讲述Nginx服务器配置时介绍它的日志功能，那里会涉及本目录的使用，在此也不再赘述。
* **nginx.exe** 即为启动Nginx服务器的运行程序。如果conf目录下的nginx.conf文件配置正确，通过它即可完成nginx服务器的启动操作。

## 2.4 Nginx服务器基础配置指令

从上面的内容我们知道，默认的Nginx服务器配置文件都存放在安装目录conf中，主配置文件名为nginx.conf。这一节，我们学习nginx.conf的内容和基本配置方法。

以下代码清单是默认的nginx.conf文件中的完整内容。

**注意**

在nginx.conf原始文件中，还包括注释内容，注释标志为“#”，由于篇幅所限，代码清单中将所有的注释去除。笔者添加的注释说明了各条语句的生效范围，让大家对指令的作用域有一个初步的了解，后面章节我们会进一步讲解。

```
worker_processes 1;								#全局生效

events {
	worker_connections 1024; 					#在events部分中生效
}

http{
	include mime.types; 						#以下指令在http部分中生效
	default_type application/octet-stream;
	sendfile on;
	keepalive_timeout 65;
		server{ 								#以下指令在http的server部分中生效
			listen 80;
			server_name localhost;
			location / { 						#以下指令在http/server的location中生效
				root html;
				index index.html index.htm;
			}
			error_page 500 502 503 504 /50x.html
			location = /50x.html {
				root html;
			}
		}
}
```

初始的Nginx服务器主配置文件比较长，不过结构和内容还是比较清晰的，以下我们分小节对上面的内容进行详细介绍。

### 2.4.1 nginx.conf文件的结构

从上面的配置文件内容，我们可以归纳出nginx.conf文件的基本结构为：（“#”后边的内容是笔者添加的注释内容，它们的含义在后文中会给出）：

```json
...                                            #全局块
events                                         #events块
{
    ...
}
http                                           #http块
{
    ...                                        #http全局块
	server                                     #server块
	{
		...
		location [PATTERN]                     #location块
		{
			...
		}
		location [PATTERN]                     #location块
		{
			...
		}
	}
	server                                     #server块
	{
		...
	}
	...                                        #http全局块
}
```

最外层的花括号将内容整体分为两部分，再加上最开始的内容，即第一行省略号表示的，nginx.conf一共由三部分组成，分别为全局块、events块和http块。在http块中，又包含http全局块、多个server块。每个server块中，可以包含server全局块和多个location块。在同一配置块中嵌套的配置块，各个之间不存在次序关系。

配置文件支持大量可配置的指令，绝大多数指令不是特定属于某一个块的。同一个指令放在不同层级的块中，其作用域也不同，一般情况下，高一级块中的指令可以作用于自身所在的块和此块包含的所有低层级块。如果某个指令在两个不同层级的块中同时出现，则采用“就近原则”，即以较低层级块中的配置为准。比如，某指令同时出现在http全局块中和server块中，并且配置不同，则应该以server块中的配置为准。

在介绍可配置指令之前，我们先来看看各个块的作用。



**1. 全局块**

全局块是默认配置文件从开始到events块之间的一部分内容，主要设置一些影响Nginx服务器整体运行的配置指令，因此，这些指令的作用域是Nginx服务器全局。

通常包括配置运行Nginx服务器的用户（组）、允许生成的worker process数、Nginx进程PID存放路径、日志的存放路径和类型以及配置文件引入等。

**2. events块**

events块涉及的指令主要影响Nginx服务器与用户的网络连接。常用到的设置包括是否开启对多worker process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型处理连接请求，每个worker process可以同时支持的最大连接数等。

这一部分的指令对Nginx服务器的性能影响较大，在实际配置中应该根据实际情况灵活调整。相关的详细分析我们在本书后面的相关章节会陆续学习。

**3. http块**

http块是Nginx服务器配置中的重要部分，代理、缓存和日志定义等绝大多数的功能和第三方模块的配置都可以放在这个模块中。

前面已经提到，http块中可以包含自己的全局块，也可以包含server块，server块中又可进一步包含location块，在本书中我们使用“http全局块”来表示http中自己的全局块，即http块中不包含在server块中的部分。

可以在http全局块中配置的指令包括文件引入、MIME-Type定义、日志自定义、是否使用sendfile传输文件、连接超时时间、单连接请求数上限等。

**4. server块**

server块和“虚拟主机”的概念有密切联系。为了加深对相关配置的理解，在介绍server块之前，我们简单了解一下虚拟主机的相关内容。

虚拟主机，又称虚拟服务器、主机空间或是网页空间，它是一种技术。该技术是为了节省互联网服务器硬件成本而出现的。这里的“主机”或“空间”是由实体的服务器延伸而来，硬件系统可以基于服务器群，或者单个服务器等。虚拟主机技术主要应用于HTTP、FTP及EMAIL等多项服务，将一台服务器的某项或者全部服务内容逻辑划分为多个服务单位，对外表现为多个服务器，从而充分利用服务器硬件资源。从用户角度来看，一台虚拟主机和一台独立的硬件主机是完全易用的。

在使用Nginx服务器提供Web服务时，利用虚拟主机的技术就可以避免为每一个要运行的完整提供单独的Nginx服务器，也无需为每个网站对应运行一组Nginx进程。虚拟主机技术使得Nginx服务器可以在同一台服务器上只运行一组Nginx进程，就可以运行多个网站。那么，如何对Nginx进行配置才能达到这种效果呢？本节介绍的server块就是用来完成这个功能的。

在前面提到过，每一个http块都可以包含多个server块，而每个server块就相当于一台虚拟主机，它内部可有多台主机联合提供服务，一起对外提供在逻辑上关系密切的一组服务（或网站）。我们先来学习server全局块中常见的指令及其配置。server全局块指令的作用域为本server块，其不会影响到其他的server块。

> **注意**
>
> 在http全局块中介绍过的部分指令可以在server块中和location块中使用，其作用域问题也已在前文中说明，后面就不再赘述。

和http相同，server块也可以包含自己的全局块，同时可以包含多个location块。在server全局块中，最常见的两个配置项是本虚拟主机的监听配置和本虚拟主机的名称或IP配置。

**5. location块**

每个server块中可以包含多个location块。从严格意义上说，location其实是server块的一个指令，只是由于其在整个Nginx配置文档中起着重要的作用，而且Nginx服务器在许多功能上的灵活性往往在location指令的配置中体现出来，因此笔者认为应该将其单独列为一个“块”，一方面引起读者的重视，另一方面通过专门的详细介绍突出其重要性，加深读者的理解。

这些location块的主要作用是，基于Nginx服务器接收到