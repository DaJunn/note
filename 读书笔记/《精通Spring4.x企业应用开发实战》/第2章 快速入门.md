# 第2章 快速入门

本章通过一个简单的例子展现开发Spring Web应用的整体过程，通过这个实例，读者可以快速跨入Spring Web应用的世界。实例应用按持久层、业务层和展现层进行组织，从底层DAO到Web展现逐层演进，一步步地搭建起一个完整的实例。通过本章的学习， 读者可以独立完成一个典型的基于Spring的Web应用。

**本章主要内容：**

* Maven构建工具介绍
* 用户登录实例介绍
* 基于Spring JDBC的持久层实现
* 基于Spring声明式事务的业务层实现
* 基于Spring MVC的展现层实现
* 在IDEA中开发Web应用的过程
* 运行Web应用

**本章亮点：**

* 非传统Hello World的快速入门实例
* 通过IDEA开发工具讲解开发的过程
* 详尽的开发过程，使读者快速上手

## 2.1 实例概述

在进行实例项目具体开发之前，有必要先对项目的功能进行概述，以便对要实现的项目有一个整体性的认识。

### 2.1.1 比Hello World更适用的实例

为了让大家快速对Spring有一个切身的认识，没有什么比通过一个实际的例子更适合了。Hello World是比较经典的入门实例，但笔者认为Hello World太过简单，很难展现Spring的全貌。为了让Spring的功能轮廓更加清晰。之所以选择登录功能模块，出于以下3种原因：

* 读者对于登录模块的业务功能很熟悉，无须在业务功能介绍上花费时间。
* 登录模块“麻雀虽小，五脏俱全”，它涵盖了持久层数据访问操作、业务层事务管理及展现层MVC等企业应用常见的功能。
* 本书希望通过一个名为“小春”的论坛贯穿始终，以便能够由点及面，使读者在单纯技术性学习的酣战中深刻理解应用程序的整体开发流程。

Spring拥有持久层、业务层和展现层的“原生技术”，分别是Spring JDBC、声明式事务和Spring MVC。为了充分展现Spring本书的魅力，本章仅使用Spring的这些“原生技术”，在后续章节中将学习其他的持久层和展现层技术，只要用户愿意，就可以平滑地将其过度到其他实现技术中。

### 2.1.2 实例功能简介

论坛登录模块的功能很简单，首先登录页面提供一个带用户名/密码的输入表单，用户填写并提交表单后，服务器端程序检查是否有匹配的用户名/密码。如果用户名/密码不匹配，则返回登录页面，并给出提示；如果用户名/密码匹配，则记录用户的成功登录日志，更新用户的最后登录时间和IP，并给用户增加5个积分，然后重定向到欢迎页面，如图2-1所示。

![1560135181423](assets/1560135181423.png)

在持久层拥有两个DAO类，分别是UserDao和LoginLogDao，在业务层对应一个业务类UserService，在展现层拥有一个LoginController类和两个JSP页面，分别是登录页面login.jsp和欢迎页面main.jsp。

下面通过一张时序图来描述论坛登录模块的整体交互流程，如图2-2所示。

![1560135287381](assets/1560135287381.png)

（1）用户访问login.jsp，返回带用户名/密码表单的登录页面。

（2）用户在登录页面输入用户名/密码，提交表单到服务器，Spring根据配置调用LoginController控制器响应登录请求。

（3）LoginController调用UserService#hashMatchUser( )方法，根据用户名和密码查询是否存在匹配的用户，UserService内部通过调用持久层的UserDao完成具体的数据库访问操作。

（4）如果不存在匹配的用户，则重定向到login.jsp页面，并报告错误；否则进入下一步。

（5）LoginController调用UserService#findUserByUserName( )方法，加载匹配的User对象，并更新用户最近一次登录时间和登录IP。

（6）LoginController调用UserService#loginSuccess( )方法，进行登录成功的业务处理：首先调用UserDao#updateLoginInfo( )方法为用户添加5个积分，然后创建一个LoginLog对象，并利用LoginLogDao将其插入数据库中。

（7）重定向到欢迎页面main.jsp，欢迎页面产生响应返回给用户。

实例的所有程序位于配套网盘chapter2的目录下，本章后面的内容将逐一实现以上步骤的功能，完成这个实例的所有细节。

> **轻松一刻**
>
> 虽然本书很少采用foo和bar对变量进行命名，但相信读者对于这两个单词再熟悉不过了，它们是计算机图书中经常使用的变量名。不同的字典对foo的解释相去甚远，一说来自中国“福”字的发音，又有解释为二战时期的一种武器。将foo和bar组合在一起所构成的foobar应该最能反映其原始的意思：foobar又为foo-bar，其中bar是beyond all recognition的缩写，意为超越认知，通俗点说就是“无法识别、一塌糊涂”的意思。而foo是fu的变体，fu是英语习语fuck-up的缩写，同样是“一团糟”的意思。

## 2.2 环境准备

在进入实例的具体开发之前，需要做一些环境的准备工作，其中包括数据库表的创建、项目工程的创建、规划Spring配置文件等。本书采用MySQL 5.x数据库，如果用户机器中还未安装该数据库，则可以从http://www.mysql.org/downlowads下载并安装。为了方便读者运行本书示例代码，本书所有章节示例中连接数据库的用户名统一采用root，密码统一采用123456。如果读者安装的MySQL数据库的root用户的密码与本书不一致，则在运行本书工程示例时，需要对工程连接数据库信息进行相应调整。

> **提示**
>
> MySQL 4.1.0以前的版本不支持事务，MySQL 4.1.0本身也只对事务提供有限的支持，Spring的各种声明式事务需要底层数据库的支持，所以最好安装5.0或更高版本的MySQL。各版本主要增加的特性如下：
>
> * MySQL 5.0 增加存储过程、视图、游标、触发器、XA事务。
> * MySQL 5.1 增加事件调度器、分区、可插拔的存储引擎API、行复制、全局动态查询日志修改。
> * MySQL 5.5 默认存储引擎更改为InnoDB，提高了默认线程并发数，后台输入/输入出线程控制，主线程输入/输入速率控制，操作系统内存分配程序使用控制，适应性散列索引控制，恢复组提交，多缓冲池实例，半同步复制，中继日志自动恢复，建立快速索引，高效的数据压缩等特性。
> * MySQL 5.6 中InnoDB性能加强，InnoDB死锁新消息可以记录到错误日志，支持主从延时复制，增强行级复制功能，基于CRC32校验的复制事件等。

### 2.2.1 构建工具Maven

Maven是Apache的一个顶级项目（http://maven.apache.org），也是一款强大的构建工具，能够帮助用户建立一套有效的自动化构建体系。从清理、编译、测试到生成报告，再到打包和部署，无须一遍又一遍地输入命令，一次又一次地单击鼠标，只需按照Maven提供的POM配置好项目模块间的相互依赖关系及相关的Maven插件，然后输入简单命令（如mvn clean install），Maven就能完成那些烦琐的构建任务。读者若想深入学习，可以参考《Maven 实战》一书

### 2.2.2 创建库表

### 2.2.3 建立工程

考虑到InterlliJ IDEA是一款非常有效且强大的IDE工具，越来越受到广大开发人员的欢迎，本书的所有示例都采用IDEA进行开发。

### 2.2.4 类包及Spring配置文件规划

**1. 类包规划**

类包以分层的方式进行组织，共划分为4个包，分别是dao、domain、service和web。领域对象从严格意义上讲属于业务层，但由于领域对象可能同时被持久层和展现层共享，所以一般将其单独划分到一个包中。如图2-10所示。

![1559966535230](assets/1559966535230.png)

单元测试的类包和程序的类包对应，但放置在不同的文件夹下，如图2-11所示。本实例仅对业务层的业务类进行单元测试。将程序类和测试类放置在物理不同的文件夹下，方便将来程序的打包和分发，因为测试类仅在开发时有用，无须包含到部署包中。在本章的后续内容中，读者将会看到如何用Maven工具进行程序打包，体会这种包及目录的设计结构所带来的好处。

![1559966686241](assets/1559966686241.png)

> **实战经验**
>
> 随着项目规模的增大，这种仅以分层实现划分的包结构就会显示出它的不足。一般情况下，需要在业务模块包下进一步按分层模块划分子包，如user/dao、user/service、viewspace/dao、viewspace/service等。对于由若干独立的子系统组成的大型应用，在业务分层包的前面一般还需要加上子系统的前缀。包的规划对于大型应用非常重要，它直接关系到应用部署和分发的便利性。

**2. Spring配置文件规划**

Spring可以将所有的配置信息统一到一个文件中，也可以放置到多个文件中。对于简单的应用来说，由于配置信息少，仅用一个配置文件就足以应付。随着应用规模的扩大，配置信息量的增多，仅使用一个配置文件往往难以满足要求。如果不进行仔细规划，则将给配置信息的查看和团队协作带来负面影响。

配置文件在团队协作时是资源争用的焦点，对于大型应用一般要按模块进行划分，以在一定程度上降低争用，减少团队协作的版本控制冲突。由于我们应用比较小，所以直接采用一个配置文件spring-context.xml即可。

## 2.3 持久层

持久层负责数据的访问和操作，DAO类被上层的业务类调用。Spring本身支持多种流行的ORM框架，这里使用Spring JDBC作为持久层的实现技术。为了方便阅读，我们会对本章涉及的相关知识进行必要的介绍，所以在不了解Spring JDBC的情况下，相信读者也可以轻松阅读本章的内容。

### 2.3.1 创立领域对象

领域对象（Domain Object）也被称为实体类，它代表了业务的状态，且贯穿展现层、业务层和持久层，并最终被持久化到数据库中。领域对象使数据库表操作以面向对象的方式进行，为程序扩展带来了更大的灵活性。领域对象不一定等用于数据库表，不过对于简单的应用来说，领域对象往往拥有对应的数据库表。

持久层的主要工作就是从数据库表中加载并实例化领域对象，或将领域对象持久化到数据库表中。

> **提示**
>
> 领域模型中的实体类可细分为4种类型：VO、DTD、DO、PO。PO（Persistent Object）：持久化对象，表示持久层的数据结构（如数据库表）；DO（Domain Object）：领域对象，即业务实体对象；DTO（Data Transfer Object）：数据传输对象，原来的目的是为EJB的分布式应用提供粗粒度的数据实体，以降低分布式调用的次数，提高分布式调用的性能，后来一般泛指用于展示层与服务层之间的数据传输对象，因此可以将DTO看成一个组合版的DO；VO（View Object）：视图对象，用于展示层视图状态对应的对象。从分层角度来说，PO、DO/DTO、VO分别属于持久层、服务层和展现层。对于简单模块来说，有时PO、DO和VO并没有什么区别，这时就没有必要分别定义DO和VO了，直接复用PO即可。

### 2.3.2 UserDao

在Spring 2.5以后，可以使用注解的方式定义Bean。较之于XML配置方式，注解配置方式的简单性非常明显，已经被广泛接受，成为一种趋势。所以除非没有办法，否则我们应尽量采用注解的配置方式。

### 2.3.3 LoginLogDao

### 2.3.4 在Spring中装配DAO

在编写DAO接口的实现类时，大家也许会有一个问题：在以上两个DAO实现类中没有打开/释放Connection的代码，DAO类究竟如何访问数据库呢？前面说过，样板式的操作

